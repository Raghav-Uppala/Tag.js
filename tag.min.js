class tagJS{constructor(t,i){this.mainDiv=t,this.modifiers=i.modifiers||["@"],this.acceptedTags=i.acceptedTags||[],this.whitelist=i.whitelist||!1,this.repeatedTags=i.repeatedTags||[],this.tagClassName=i.tagClassName||"tag",this.inputDivClassName=i.inputDivClassName||"inputDiv",this.tagProperties=i.tagProperties||!1,this.tagPropertyDelim=i.tagPropertyDelim||":",this.onSubmit=i.onSubmit||function(t){},this.inputDivId=i.inputDivId||"inputDiv",this.tagDelButton=i.tagDelButton||"&times";let e=document.createElement("div");e.contentEditable=!0,e.className=this.inputDivClassName,e.id=this.inputDivId,t.appendChild(e),this.inputDiv=e,this.tags=[],this.tagsids=[this.inputDivId],this.focusElem=this.inputDiv,this.modifier="",this.modifierPosition=0,this.tag=!1,this.escapeTag=!1,this.tagLen=0,this.runFunction()}setCaret(t,i=this.inputDiv){let e=document.createRange(),s=window.getSelection(),n=i;"end"==t&&(0==i.childNodes.length?t=i.innerText.length:(t=i.childNodes[0].data.length,n=i.childNodes[0])),0!=n.childNodes.length&&(e.setStart(n.childNodes[0],t),e.collapse(!0),s.removeAllRanges(),s.addRange(e))}getCaretPosition(){let t=document.activeElement;var i=window.getSelection(),e=[0,0];if(i.anchorNode==t)e=[i.anchorOffset,i.focusOffset,i.focusNode];else{var s=[i.anchorNode,i.focusNode];if(!t.contains(i.anchorNode)||!t.contains(i.focusNode))return;var n,a=[0,0];this.node_walk(t,function(t){for(n=0;n<2;n++)if(t==s[n]&&(a[n]=!0,a[0==n?1:0]))return!1;if(t.textContent&&!t.firstChild)for(n=0;n<2;n++)a[n]||(e[n]+=t.textContent.length)}),e[0]+=i.anchorOffset,e[1]+=i.focusOffset}return e}node_walk(t,i){var e=i(t);for(t=t.firstChild;!1!==e&&t;t=t.nextSibling)e=this.node_walk(t,i);return e}searchForArray(t,i){var e,s,n;for(e=0;e<t.length;++e)if(i.length===t[e].length){for(s=0,n=t[e];s<i.length&&i[s]===n[s];++s);if(s===i.length)return e}return -1}onInput(t){if(!0==this.tag&&(this.getCaretPosition()[0]<this.modifierPosition||!0==this.escapeTag)){if(this.tag=!1,"deleteContentBackward"===t.inputType||"deleteContentForward"==t.inputType){this.tagLen=0;return}this.createTag(),this.tagLen=0;return}"insertText"==t.inputType&&(this.modifiers.includes(t.data)?(this.modifierPosition=this.getCaretPosition()[0],this.tag=!0,this.modifier=t.data):!0==this.tag&&(this.getCaretPosition()[0],this.tagLen+=1)),("deleteContentBackward"==t.inputType||"deleteContentForward"==t.inputType)&&!0==this.tag&&(this.tagLen-=1),"insertParagraph"==t.inputType&&t.preventDefault()}createTag(t=!1){let i,e=0;this.getCaretPosition()[0]-1<this.modifierPosition?(i=this.modifierPosition+1,e=this.modifierPosition+this.tagLen+1):!0==t&&(i=this.modifierPosition,e=this.modifierPosition+this.tagLen);let s=this.inputDiv.innerText.substring(i,e).trim(),n=s,a=[];if(!0==this.tagProperties&&s.includes(this.tagPropertyDelim)&&([n,a]=s.split(this.tagPropertyDelim),a=a.split(",").map(t=>t.trim())),!0==this.whitelist&&!this.acceptedTags.includes(n)){console.log("not whitelisted");return}if(this.inputDiv.innerText=this.inputDiv.innerText.substring(0,i-1)+this.inputDiv.innerText.substring(e,this.inputDiv.innerText.length),this.setCaret(i-1),!1==this.repeatedTags&&this.searchForArray(this.tags,[n,this.modifier,a])>-1){console.log("repeated");return}this.addTag(n,this.modifier,a)}addTag(t,i,e){this.tags.push([t,i,e]),this.tagsids.splice(this.tagsids.length-1,0,"tag_"+(this.tags.length-1));let s=document.createElement("div"),n=document.createElement("div");n.className="tagDelButton",n.innerHTML=this.tagDelButton,n.onclick=()=>{this.removeTag(this.tags.length-1)};let a=document.createElement("div");a.innerText=t+(0!=e.length?":"+e:""),a.contentEditable=!0,a.id="tag_"+(this.tags.length-1)+"_editor",s.className=this.tagClassName,s.id="tag_"+(this.tags.length-1),this.mainDiv.insertBefore(s,this.inputDiv),s.prepend(n),s.append(a)}returnString(){return{inputStr:this.inputDiv.innerText.trim(),tags:this.tags}}removeTag(t){this.tags.splice(t,1),this.tagsids.splice(t,1),this.mainDiv.removeChild(this.mainDiv.querySelector("#tag_"+t))}changeFocus(t,i=!1){let e=this.focusElem,s=this.focusElem.id,n=this.tagsids.indexOf(s),a;if(!1==i){let h;h=n+t<0?this.tagsids[this.tagsids.length+(n+t)]:n+t>this.tagsids.length-1?this.tagsids[n+t-this.tagsids.length]:this.tagsids[n+t],a=this.mainDiv.querySelector("#"+h),this.focusElem=a,h.includes("tag_")&&(a=a.querySelector("#"+h+"_editor")),s.includes("tag_")&&((e=e.querySelector("#"+s+"_editor")).innerText=this.tags[n][0]+(0!=this.tags[n][2].length?":"+this.tags[n][2]:""))}else a=i,this.focusElem=a;a.contentEditable=!0,e.contentEditable=!1,a.focus()}editTag(t,i){if(void 0==this.tags[t])return;let e=i,s=[],n=document.querySelector("#tag_"+t).querySelector("#tag_"+t+"_editor");if(!0==this.tagProperties&&i.includes(this.tagPropertyDelim)&&([e,s]=i.split(this.tagPropertyDelim),s=s.split(",").map(t=>t.trim())),!0==this.whitelist&&!this.acceptedTags.includes(e)){console.log("not whitelisted"),n.innerText=this.tags[t][0]+(0!=this.tags[t][2].length?":"+this.tags[t][2]:"");return}this.tags[t]=[e,this.modifier,s],n.innerText=e+(0!=s.length?":"+s:"")}runFunction(){this.inputDiv.addEventListener("input",t=>{this.onInput(t)}),this.inputDiv.addEventListener("keydown",t=>{"Enter"==t.key&&(!0==this.tag?(this.createTag(!0),this.tagLen=0,this.tag=!1):this.onSubmit(this.returnQuery()))}),this.mainDiv.addEventListener("keydown",t=>{if(this.tags.length>0&&("ArrowLeft"==t.key&&0==this.getCaretPosition()[0]&&0==this.getCaretPosition()[1]&&this.changeFocus(-1),"ArrowRight"==t.key&&this.getCaretPosition()[0]==document.activeElement.innerText.length&&this.getCaretPosition()[1]==document.activeElement.innerText.length&&this.changeFocus(1)),"Backspace"==t.key&&0==this.getCaretPosition()[0]&&0==this.getCaretPosition()[1]&&this.tags.length>0&&(this.focusElem==this.inputDiv?this.removeTag(this.tags.length-1):(this.removeTag(this.focusElem.id.split("_")[1]),this.changeFocus(-1)),t.preventDefault()),"Enter"==t.key){if(document.activeElement.id.includes("tag")){let i=this.tagsids.indexOf(this.focusElem.id);this.editTag(i,this.focusElem.querySelector("#tag_"+i+"_editor").innerText),this.changeFocus(0,this.inputDiv)}t.preventDefault()}})}}